#!/bin/bash

# Fallback if CONFIG_DIR not set by sketchybar
CONFIG_DIR="${CONFIG_DIR:-$HOME/.config/sketchybar}"
PLUGIN_DIR="$CONFIG_DIR/plugins"

# Load system accent color (reads macOS AppleAccentColor)
source "$PLUGIN_DIR/accent_color.sh"

##### Color Palette #####
TRANSPARENT=0x00000000
GLASS_BG=0x26ffffff
GLASS_BORDER=0x33ffffff
WHITE=0xffffffff
WHITE_50=0x80ffffff

# Island shadow (for floating glass effect - subtle)
ISLAND_SHADOW=0x20000000

##### Nerd Font Material Design Icons (literal unicode) #####
ICON_TERMINAL="󰆍"   # nf-md-console
ICON_GLOBE="󰖟"      # nf-md-web
ICON_CODE="󰅴"       # nf-md-code-tags
ICON_SLACK="󰒱"      # nf-md-slack
ICON_SPOTIFY="󰓇"    # nf-md-spotify
ICON_CLOCK="󰥔"      # nf-md-clock
ICON_CALENDAR="󰃭"   # nf-md-calendar
ICON_VOLUME="󰕾"     # nf-md-volume-high
ICON_APPS="󰀻"       # nf-md-apps
ICON_NUMERIC="󰎤"    # nf-md-numeric (for generic workspaces)

##### Bar Appearance #####
# Fully transparent bar - islands provide their own backgrounds
sketchybar --bar \
  position=top \
  height=40 \
  color=$TRANSPARENT \
  shadow=off \
  padding_left=10 \
  padding_right=10 \
  margin=10 \
  y_offset=4 \
  corner_radius=0 \
  blur_radius=0

##### Defaults #####
default=(
  icon.font="Hack Nerd Font:Bold:14.0"
  label.font="Hack Nerd Font:Bold:12.0"
  icon.color=$WHITE
  label.color=$WHITE
  icon.padding_left=6
  icon.padding_right=2
  label.padding_left=2
  label.padding_right=6
  background.drawing=off
)
sketchybar --default "${default[@]}"

##### Left Island 1: Front App #####
sketchybar --add item front_app left \
  --set front_app \
    icon="$ICON_APPS" \
    icon.color=$ACCENT_LIGHT \
    icon.font="Hack Nerd Font:Bold:14.0" \
    icon.padding_left=8 \
    icon.padding_right=2 \
    label.color=$WHITE \
    label.font="Hack Nerd Font:Bold:12.0" \
    label.padding_left=0 \
    label.padding_right=8 \
    label.max_chars=15 \
    script="$PLUGIN_DIR/front_app.sh" \
  --subscribe front_app front_app_switched

# Front app island background
sketchybar --add bracket front_app_island front_app \
  --set front_app_island \
    background.drawing=on \
    background.color=$GLASS_BG \
    background.border_color=$GLASS_BORDER \
    background.border_width=1 \
    background.corner_radius=14 \
    background.height=28 \
    background.blur_radius=50 \
    background.shadow.drawing=on \
    background.shadow.color=$ISLAND_SHADOW \
    background.shadow.distance=3 \
    background.shadow.angle=90

# Spacer between islands
sketchybar --add item spacer_left left \
  --set spacer_left \
    icon.drawing=off \
    label.drawing=off \
    width=8

##### Left Island 2: Workspaces #####
sketchybar --add event aerospace_workspace_change

# Workspace icons based on app assignments
ICON_FOLDER="󰉋"    # nf-md-folder

declare -A WORKSPACE_ICONS
WORKSPACE_ICONS=(
  [1]="$ICON_TERMINAL"  # Ghostty
  [2]="$ICON_GLOBE"     # Chrome/Safari
  [3]="$ICON_CODE"      # Cursor
  [4]="$ICON_SLACK"     # Slack/Discord
  [5]="$ICON_SPOTIFY"   # Spotify
  [6]="$ICON_FOLDER"
  [7]="$ICON_FOLDER"
  [8]="$ICON_FOLDER"
  [9]="$ICON_FOLDER"
)

workspaces=$(aerospace list-workspaces --all)

for sid in $workspaces; do
  icon="${WORKSPACE_ICONS[$sid]:-$sid}"

  # All workspaces use same layout: icon + number
  sketchybar --add item space.$sid left \
    --subscribe space.$sid aerospace_workspace_change \
    --set space.$sid \
      icon="$icon" \
      icon.color=$WHITE_50 \
      icon.font="Hack Nerd Font:Bold:14.0" \
      icon.padding_left=6 \
      icon.padding_right=2 \
      label="$sid" \
      label.color=$WHITE_50 \
      label.font="Hack Nerd Font:Bold:11.0" \
      label.padding_left=0 \
      label.padding_right=6 \
      click_script="aerospace workspace $sid" \
      script="$PLUGIN_DIR/aerospace.sh $sid"
done

# Workspaces island background bracket
sketchybar --add bracket workspaces_island '/space\..*/' \
  --set workspaces_island \
    background.drawing=on \
    background.color=$GLASS_BG \
    background.border_color=$GLASS_BORDER \
    background.border_width=1 \
    background.corner_radius=14 \
    background.height=28 \
    background.blur_radius=50 \
    background.shadow.drawing=on \
    background.shadow.color=$ISLAND_SHADOW \
    background.shadow.distance=3 \
    background.shadow.angle=90

##### Right Island: Status Items #####

# Date (leftmost in right island)
sketchybar --add item date right \
  --set date \
    update_freq=60 \
    icon="$ICON_CALENDAR" \
    icon.color=$ACCENT_LIGHT \
    icon.font="Hack Nerd Font:Bold:14.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.padding_left=0 \
    label.padding_right=8 \
    script="$PLUGIN_DIR/date.sh" \
    click_script="$PLUGIN_DIR/click_calendar.sh"

# Separator
sketchybar --add item sep0 right \
  --set sep0 \
    icon.drawing=off \
    label=│ \
    label.color=$WHITE_50 \
    label.font="Hack Nerd Font:Regular:12.0" \
    label.padding_left=0 \
    label.padding_right=0

# Clock
sketchybar --add item clock right \
  --set clock \
    update_freq=10 \
    icon="$ICON_CLOCK" \
    icon.color=$ACCENT_LIGHT \
    icon.font="Hack Nerd Font:Bold:14.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.padding_left=0 \
    label.padding_right=8 \
    script="$PLUGIN_DIR/clock.sh" \
    click_script="$PLUGIN_DIR/click_clock.sh"

# Separator
sketchybar --add item sep1 right \
  --set sep1 \
    icon.drawing=off \
    label=│ \
    label.color=$WHITE_50 \
    label.font="Hack Nerd Font:Regular:12.0" \
    label.padding_left=0 \
    label.padding_right=0

# Battery
sketchybar --add item battery right \
  --set battery \
    update_freq=120 \
    icon.color=$ACCENT_LIGHT \
    icon.font="Hack Nerd Font:Bold:16.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:11.0" \
    label.padding_left=0 \
    label.padding_right=8 \
    script="$PLUGIN_DIR/battery.sh" \
    click_script="$PLUGIN_DIR/click_battery.sh" \
  --subscribe battery system_woke power_source_change

# Separator
sketchybar --add item sep2 right \
  --set sep2 \
    icon.drawing=off \
    label=│ \
    label.color=$WHITE_50 \
    label.font="Hack Nerd Font:Regular:12.0" \
    label.padding_left=0 \
    label.padding_right=0

# Volume (rightmost in right island)
sketchybar --add item volume right \
  --set volume \
    icon="$ICON_VOLUME" \
    icon.color=$ACCENT_LIGHT \
    icon.font="Hack Nerd Font:Bold:14.0" \
    icon.padding_left=8 \
    icon.padding_right=4 \
    label.font="Hack Nerd Font:Bold:11.0" \
    label.padding_left=0 \
    label.padding_right=8 \
    scroll_texts=off \
    script="$PLUGIN_DIR/volume.sh" \
    click_script="$PLUGIN_DIR/click_sound.sh" \
  --subscribe volume volume_change mouse.scrolled \
  --set volume scroll_up_script="$PLUGIN_DIR/volume_up.sh" \
               scroll_down_script="$PLUGIN_DIR/volume_down.sh"

# Right island background bracket
sketchybar --add bracket right_island volume sep2 battery sep1 clock sep0 date \
  --set right_island \
    background.drawing=on \
    background.color=$GLASS_BG \
    background.border_color=$GLASS_BORDER \
    background.border_width=1 \
    background.corner_radius=14 \
    background.height=28 \
    background.blur_radius=50 \
    background.shadow.drawing=on \
    background.shadow.color=$ISLAND_SHADOW \
    background.shadow.distance=3 \
    background.shadow.angle=90

##### Initialize #####
sketchybar --update
